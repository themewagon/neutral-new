name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Update paths for GitHub Pages
        run: |
          BASE_URL="/neutral-new"
          python3 << 'PYTHON_SCRIPT'
          import os
          import re
          from pathlib import Path

          base_url = "/neutral-new"

          # Find all HTML files
          html_files = []
          for root, dirs, files in os.walk('.'):
              # Skip vendor and node_modules directories
              dirs[:] = [d for d in dirs if d not in ['vendors', 'node_modules', '.git']]
              for file in files:
                  if file.endswith('.html'):
                      html_files.append(os.path.join(root, file))

          for file_path in html_files:
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # Get directory relative to root
              file_dir = os.path.dirname(file_path).lstrip('./')
              if file_dir == '.':
                  file_dir = ''
              
              # Function to check if link already has base URL
              def has_base_url(match):
                  return base_url in match.group(0)
              
              # 1. Handle ../src/ and ../vendors/ paths
              content = re.sub(r'(href|src)="\.\./(src|vendors)/', 
                              lambda m: f'{m.group(1)}="{base_url}/{m.group(2)}/' if base_url not in m.group(0) else m.group(0),
                              content)
              
              # 2. Handle root-level src/ and vendors/ paths (skip if already has base_url)
              content = re.sub(r'(href|src)="(?!' + re.escape(base_url) + r'/)(src|vendors)/',
                              lambda m: f'{m.group(1)}="{base_url}/{m.group(2)}/',
                              content)
              
              # 3. Handle ../ HTML links
              content = re.sub(r'href="\.\./(?!' + re.escape(base_url) + r'/)([^"#]*\.html)"',
                              lambda m: f'href="{base_url}/{m.group(1)}"',
                              content)
              
              # 4. Handle same-directory HTML links
              if file_dir:
                  # File is in subdirectory
                  content = re.sub(r'href="(?!' + re.escape(base_url) + r'/|\.\./|/|https?://|mailto:|#)([^/"#h]*\.html)"',
                                  lambda m: f'href="{base_url}/{file_dir}/{m.group(1)}"',
                                  content)
              else:
                  # File is in root
                  content = re.sub(r'href="(?!' + re.escape(base_url) + r'/|\.\./|/|https?://|mailto:|#)([^/"#h]*\.html)"',
                                  lambda m: f'href="{base_url}/{m.group(1)}"',
                                  content)
              
              # 5. Handle root-level HTML links starting with / (only match explicit / links)
              # Changed /? to / to avoid matching same-dir links that step 4 handles
              content = re.sub(r'href="/(?!' + re.escape(base_url) + r'/)([^"#]*\.html)"',
                              lambda m: f'href="{base_url}/{m.group(1)}"',
                              content)
              
              # 6. Clean up duplicates
              content = content.replace(base_url + base_url, base_url)
              content = content.replace(base_url + '//', base_url + '/')
              
              with open(file_path, 'w', encoding='utf-8') as f:
                  f.write(content)

          print("âœ“ All paths updated successfully!")
          PYTHON_SCRIPT

      - name: Build project
        run: npm run build || echo "Build step skipped (no build script or build failed)"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
